<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–±–ª–µ–º–∞ Jeans</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; }
        .btn:hover { background: #0056b3; }
        .file-input { display: none; }
        .file-btn { background: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; display: inline-block; }
        .loading { display: none; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üì± –ü—Ä–æ–±–ª–µ–º–∞ Jeans</h2>
        
        <form id="jeansForm">
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã *</label>
                <textarea name="problem_description" required placeholder="–û–ø–∏—à–∏—Ç–µ —Å—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã..."></textarea>
            </div>

            <div class="form-group">
                <label>–ü—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ —É –≤–∞—Å –∏–ª–∏ –º–∞—Å—Å–æ–≤–∞—è? *</label>
                <select name="problem_scope" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç</option>
                    <option value="—É –º–µ–Ω—è">–¢–æ–ª—å–∫–æ —É –º–µ–Ω—è</option>
                    <option value="–º–∞—Å—Å–æ–≤–∞—è">–ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞</option>
                </select>
            </div>

            <div class="form-group">
                <label>–°–∫—Ä–∏–Ω—à–æ—Ç—ã –∏–ª–∏ –∑–∞–ø–∏—Å—å —ç–∫—Ä–∞–Ω–∞</label>
                <button type="button" class="file-btn" onclick="document.getElementById('fileInput').click()">
                    üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª
                </button>
                <input type="file" id="fileInput" class="file-input" accept="image/*,video/*,.pdf">
                <div id="fileName"></div>
            </div>

            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω –¢–ü–î *</label>
                <input type="text" name="tpd_login" required value="" placeholder="–í–∞—à –ª–æ–≥–∏–Ω">
            </div>

            <div class="form-group">
                <label>ID –¢–¢, –≥–¥–µ –±—ã–ª–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ *</label>
                <input type="text" name="tt_id" required placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏">
            </div>

            <div class="form-group">
                <label>–í–µ—Ä—Å–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
                <input type="text" name="device_version" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Android 12, iOS 15">
            </div>

            <div class="form-group">
                <label>–í–µ—Ä—Å–∏—è Jeans/–í–µ—Ä—Å–∏—è JedAI</label>
                <input type="text" name="app_version" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Jeans 2.5.1">
            </div>

            <div class="form-group">
                <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã *</label>
                <input type="datetime-local" name="problem_date" required>
            </div>

            <div class="form-group">
                <label>–ü—Ä–æ–±–ª–µ–º–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤—Å–µ–≥–¥–∞ –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å? *</label>
                <input type="text" name="reproducibility" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≤—Å–µ–≥–¥–∞, —Ç–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏">
            </div>

            <div class="form-group">
                <label>–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ —à–∞–≥–∏ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è *</label>
                <textarea name="steps_to_reproduce" required placeholder="–ü–æ—à–∞–≥–æ–≤–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è..."></textarea>
            </div>

            <input type="hidden" name="form_type" value="–ü—Ä–æ–±–ª–µ–º–∞ Jeans">
            
            <div class="loading" id="loading">
                <p>‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è...</p>
            </div>
            
            <button type="submit" class="btn" id="submitBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
        </form>
    </div>

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL
const urlParams = new URLSearchParams(window.location.search);
const userDataParam = urlParams.get('user_data');
let userData = {};

if (userDataParam) {
    try {
        userData = JSON.parse(decodeURIComponent(userDataParam));
        document.querySelector('input[name="tpd_login"]').value = userData.tpd_login || '';
    } catch (e) {
        console.error('Error parsing user data:', e);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
if (window.Telegram && window.Telegram.WebApp) {
    console.log('WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    console.log('User data:', userData);
    
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand(); // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –µ–¥–∏–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –≤—Å–µ—Ö –ø–æ–ª–µ–π
function buildDescription(formData) {
    const fields = {
        '–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã': formData.get('problem_description'),
        '–û–±–ª–∞—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã': formData.get('problem_scope'),
        '–õ–æ–≥–∏–Ω –¢–ü–î': formData.get('tpd_login'),
        'ID –¢–¢': formData.get('tt_id'),
        '–í–µ—Ä—Å–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞': formData.get('device_version'),
        '–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è': formData.get('app_version'),
        '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–æ–±–ª–µ–º—ã': formData.get('problem_date'),
        '–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å': formData.get('reproducibility'),
        '–®–∞–≥–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è': formData.get('steps_to_reproduce')
    };

    let description = '';
    for (const [fieldName, fieldValue] of Object.entries(fields)) {
        if (fieldValue && fieldValue.trim() !== '') {
            description += `**${fieldName}:** ${fieldValue}\n\n`;
        }
    }

    return description.trim();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è FormData –≤ –æ–±—ä–µ–∫—Ç
function formDataToObject(formData) {
    const object = {};
    for (let [key, value] of formData.entries()) {
        object[key] = value;
    }
    return object;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
function handleFileAttachment(fileInput) {
    if (fileInput.files.length === 0) {
        return null;
    }
    
    return new Promise((resolve) => {
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const base64 = e.target.result.split(',')[1]; // –£–±–∏—Ä–∞–µ–º data:image/... –ø—Ä–µ—Ñ–∏–∫—Å
            resolve({
                attachment: base64,
                attachment_name: file.name,
                attachment_type: file.type
            });
        };
        
        reader.onerror = function() {
            console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
            resolve(null);
        };
        
        reader.readAsDataURL(file);
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
document.getElementById('jeansForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    
    submitBtn.style.display = 'none';
    loading.style.display = 'block';
    
    try {
        const formData = new FormData(this);
        const fileInput = document.getElementById('fileInput');
        
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –Ω–∞—á–∞—Ç–∞');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –µ–¥–∏–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –≤—Å–µ—Ö –ø–æ–ª–µ–π
        const description = buildDescription(formData);
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π FormData —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–ª—è API
        const apiFormData = new FormData();
        
        // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è API
        apiFormData.append('user_tg_id', userData.user_tg_id || '');
        apiFormData.append('user_email', userData.user_email || '');
        apiFormData.append('service', 'SM Jeans Mobile App Supplier');
        apiFormData.append('appeal_type', 'INC');
        apiFormData.append('theme', '–û–±—Ä–∞—â–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –≤ —Ä–∞–±–æ—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Jeans/Jedai');
        apiFormData.append('description', description);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (fileInput.files.length > 0) {
            apiFormData.append('attachments', fileInput.files[0]);
        }
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ API:');
        for (let [key, value] of apiFormData.entries()) {
            console.log(key + ': ' + (value instanceof File ? value.name : value));
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ API
        const response = await fetch('https://ittest.brew4ru.net/api/extensions/091a0cd9-2c50-4769-8136-27b4d092eb08/script/createTicket', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer d551618e-726b-48e7-acac-5b2a53380857'
            },
            body: apiFormData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.text();
        console.log('–û—Ç–≤–µ—Ç API:', result);
        
        // –ü–∞—Ä—Å–∏–º –Ω–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞
        let ticketId = '–ù/–î';
        const ticketMatch = result.match(/ticket\s+(\d+)\s+is created/i);
        if (ticketMatch) {
            ticketId = ticketMatch[1];
        } else {
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–∏—Å–∫–∞ –Ω–æ–º–µ—Ä–∞
            const numbers = result.match(/\d+/g);
            if (numbers && numbers.length > 0) {
                ticketId = numbers[0];
            }
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–æ—Ç
        const formDataObject = formDataToObject(formData);
        const fileAttachment = await handleFileAttachment(fileInput);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –±–æ—Ç
        const webAppData = {
            action: 'create_ticket',
            form_type: 'jeans',
            form_data: {
                ...formDataObject,
                ticket_id: ticketId,
                api_response: result
            },
            user_data: userData
        };
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
        if (fileAttachment) {
            webAppData.form_data.attachment = fileAttachment.attachment;
            webAppData.form_data.attachment_name = fileAttachment.attachment_name;
            webAppData.form_data.attachment_type = fileAttachment.attachment_type;
        }
        
        console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–æ—Ç:', webAppData);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç
        if (window.Telegram && window.Telegram.WebApp) {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram WebApp');
            window.Telegram.WebApp.sendData(JSON.stringify(webAppData));
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç
            setTimeout(() => {
                console.log('–ó–∞–∫—Ä—ã—Ç–∏–µ WebApp');
                window.Telegram.WebApp.close();
            }, 1500);
            
        } else {
            // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
            alert(`‚úÖ –û–±—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! –ù–æ–º–µ—Ä: ${ticketId}\n–û—Ç–≤–µ—Ç API: ${result}`);
            console.log('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±–æ—Ç–∞:', webAppData);
        }
        
    } catch (error) {
        console.error('Error:', error);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç —Å –æ—à–∏–±–∫–æ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–æ—Ç
        const errorData = {
            action: 'create_ticket',
            form_type: 'jeans',
            status: 'error',
            error: error.message,
            user_data: userData
        };
        
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.sendData(JSON.stringify(errorData));
            setTimeout(() => {
                window.Telegram.WebApp.close();
            }, 1500);
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            console.log('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - –æ—à–∏–±–∫–∞:', errorData);
        }
    } finally {
        submitBtn.style.display = 'block';
        loading.style.display = 'none';
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
document.getElementById('fileInput').addEventListener('change', function(e) {
    const fileNameDiv = document.getElementById('fileName');
    if (this.files.length > 0) {
        fileNameDiv.innerHTML = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${this.files[0].name} (${(this.files[0].size / 1024).toFixed(2)} KB)`;
    } else {
        fileNameDiv.innerHTML = '';
    }
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('–§–æ—Ä–º–∞ Jeans –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.querySelector('input[name="problem_date"]').value = localDateTime;
});
</body>
</html>
