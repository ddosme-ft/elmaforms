<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–±–ª–µ–º–∞ Jeans</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin: 5px 0; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #cccccc; cursor: not-allowed; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .file-input { display: none; }
        .file-btn { background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; display: inline-block; }
        .loading { display: none; text-align: center; padding: 20px; }
        .error { color: #dc3545; font-size: 14px; margin-top: 5px; }
        .success { color: #28a745; font-size: 14px; margin-top: 5px; }
        .file-info { margin-top: 5px; font-size: 14px; }
        .result { display: none; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üì± –ü—Ä–æ–±–ª–µ–º–∞ Jeans</h2>
        
        <form id="jeansForm">
            <!-- –í—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –æ—Å—Ç–∞—é—Ç—Å—è -->
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã *</label>
                <textarea name="problem_description" required placeholder="–û–ø–∏—à–∏—Ç–µ —Å—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã..."></textarea>
                <div class="error" id="error-problem_description"></div>
            </div>

            <div class="form-group">
                <label>–ü—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ —É –≤–∞—Å –∏–ª–∏ –º–∞—Å—Å–æ–≤–∞—è? *</label>
                <select name="problem_scope" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç</option>
                    <option value="—É –º–µ–Ω—è">–¢–æ–ª—å–∫–æ —É –º–µ–Ω—è</option>
                    <option value="–º–∞—Å—Å–æ–≤–∞—è">–ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞</option>
                </select>
                <div class="error" id="error-problem_scope"></div>
            </div>

            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω –¢–ü–î *</label>
                <input type="text" name="tpd_login" required value="" placeholder="–í–∞—à –ª–æ–≥–∏–Ω">
                <div class="error" id="error-tpd_login"></div>
            </div>

            <div class="form-group">
                <label>ID –¢–¢, –≥–¥–µ –±—ã–ª–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ *</label>
                <input type="text" name="tt_id" required placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏">
                <div class="error" id="error-tt_id"></div>
            </div>

            <div class="form-group">
                <label>–í–µ—Ä—Å–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
                <input type="text" name="device_version" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Android 12, iOS 15">
            </div>

            <div class="form-group">
                <label>–í–µ—Ä—Å–∏—è Jeans/–í–µ—Ä—Å–∏—è JedAI</label>
                <input type="text" name="app_version" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Jeans 2.5.1">
            </div>

            <div class="form-group">
                <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã *</label>
                <input type="datetime-local" name="problem_date" required>
                <div class="error" id="error-problem_date"></div>
            </div>

            <div class="form-group">
                <label>–ü—Ä–æ–±–ª–µ–º–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤—Å–µ–≥–¥–∞ –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å? *</label>
                <input type="text" name="reproducibility" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≤—Å–µ–≥–¥–∞, —Ç–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏">
                <div class="error" id="error-reproducibility"></div>
            </div>

            <div class="form-group">
                <label>–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ —à–∞–≥–∏ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è *</label>
                <textarea name="steps_to_reproduce" required placeholder="–ü–æ—à–∞–≥–æ–≤–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è..."></textarea>
                <div class="error" id="error-steps_to_reproduce"></div>
            </div>

            <input type="hidden" name="form_type" value="–ü—Ä–æ–±–ª–µ–º–∞ Jeans">
            
            <div class="loading" id="loading">
                <p>‚è≥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
            
            <div class="result" id="result">
                <h3>‚úÖ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –≥–æ—Ç–æ–≤—ã!</h3>
                <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ –±–æ—Ç</p>
                <button type="button" class="btn btn-success" id="sendToBotBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É</button>
                <div id="formDataOutput" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; display: none;"></div>
            </div>
            
            <button type="submit" class="btn" id="submitBtn">üìù –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <button type="button" class="btn" onclick="closeForm()" style="background: #6c757d;">‚ùå –ó–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É</button>
        </form>
    </div>

<script>
    // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –†–ï–ê–õ–¨–ù–û–ô –û–¢–ü–†–ê–í–ö–ò
    console.log('=== –†–ï–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –û–¢–ü–†–ê–í–ö–ò ===');

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—ã–∑–æ–≤ sendData –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    if (window.Telegram && window.Telegram.WebApp) {
        const originalSendData = Telegram.WebApp.sendData;
        
        Telegram.WebApp.sendData = function(data) {
            console.log('üîç sendData called with:');
            console.log('üìä Data type:', typeof data);
            console.log('üìè Data length:', data.length);
            console.log('üìÑ Data content:', data);
            console.log('üî§ First 200 chars:', data.substring(0, 200));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ data —É–∂–µ –æ–±—ä–µ–∫—Ç–æ–º
            if (typeof data === 'object' && !(data instanceof String)) {
                console.warn('‚ö†Ô∏è WARNING: Data is already an object! Converting to string...');
                data = JSON.stringify(data);
                console.log('üîÑ Converted to string:', typeof data);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JSON
            try {
                JSON.parse(data);
                console.log('‚úÖ Data is valid JSON');
            } catch (e) {
                console.error('‚ùå Data is NOT valid JSON:', e);
                console.log('üîß Attempting to fix...');
                
                // –ü—Ä–æ–±—É–µ–º –ø–æ—á–∏–Ω–∏—Ç—å JSON
                try {
                    // –ï—Å–ª–∏ data - —ç—Ç–æ —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
                    if (data.startsWith('[') || data.startsWith('{')) {
                        // –£–∂–µ JSON - —Å—Ç—Ä–∞–Ω–Ω–æ —á—Ç–æ –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è
                        console.log('üîß Data looks like JSON but fails parsing');
                    } else {
                        // –í–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –æ–±—ä–µ–∫—Ç
                        const fixedData = JSON.stringify(data);
                        console.log('üîß Fixed data:', fixedData);
                        data = fixedData;
                    }
                } catch (fixError) {
                    console.error('‚ùå Cannot fix data:', fixError);
                }
            }
            
            // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
            console.log('üöÄ Calling original sendData...');
            return originalSendData.call(this, data);
        };
        
        console.log('‚úÖ sendData interceptor installed');
    }

    // –£–ü–†–û–©–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –§–û–†–ú–´
    document.getElementById('jeansForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('=== –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´ ===');
        
        // –ü—Ä–æ—Å—Ç—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const testData = {
            action: 'create_ticket',
            form_type: 'jeans',
            test_id: Math.random().toString(36).substr(2, 9),
            timestamp: new Date().toISOString(),
            simple_field: 'test value',
            number_field: 12345
        };
        
        console.log('üì¶ Test data prepared:', testData);
        
        // –í–ê–†–ò–ê–ù–¢ 1: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
        const jsonString = JSON.stringify(testData);
        console.log('üî§ JSON string:', jsonString);
        console.log('üî§ String type:', typeof jsonString);
        
        // –í–ê–†–ò–ê–ù–¢ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∫–∏
        if (window.Telegram && window.Telegram.WebApp) {
            console.log('üöÄ Attempting to send data...');
            
            // –°–ø–æ—Å–æ–± 1: –ü—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞
            try {
                Telegram.WebApp.sendData(jsonString);
                console.log('‚úÖ Method 1: String sent successfully');
            } catch (error1) {
                console.error('‚ùå Method 1 failed:', error1);
                
                // –°–ø–æ—Å–æ–± 2: –û–±–µ—Ä–Ω—É—Ç—å –≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π JSON
                try {
                    const wrappedData = JSON.stringify({data: jsonString});
                    Telegram.WebApp.sendData(wrappedData);
                    console.log('‚úÖ Method 2: Wrapped string sent');
                } catch (error2) {
                    console.error('‚ùå Method 2 failed:', error2);
                    
                    // –°–ø–æ—Å–æ–± 3: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    try {
                        const minimalData = JSON.stringify({action: 'test'});
                        Telegram.WebApp.sendData(minimalData);
                        console.log('‚úÖ Method 3: Minimal data sent');
                    } catch (error3) {
                        console.error('‚ùå Method 3 failed:', error3);
                    }
                }
            }
        } else {
            console.log('üß™ Test mode - data prepared for sending');
            alert('–î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã:\n' + jsonString);
        }
    });

    // –¢–ï–°–¢ –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–û–°–¢–ò WEBAPP
    function testWebAppConnection() {
        if (window.Telegram && window.Telegram.WebApp) {
            console.log('üîå Testing WebApp connection...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            console.log('üìã Available WebApp methods:');
            Object.keys(Telegram.WebApp).forEach(key => {
                if (typeof Telegram.WebApp[key] === 'function') {
                    console.log('üîß', key, typeof Telegram.WebApp[key]);
                }
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebApp
            Telegram.WebApp.ready();
            console.log('‚úÖ WebApp ready called');
            
            // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            Telegram.WebApp.expand();
            console.log('‚úÖ WebApp expand called');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é
            console.log('üåê WebApp version:', Telegram.WebApp.version);
            console.log('üì± Platform:', Telegram.WebApp.platform);
            
        } else {
            console.log('‚ùå Telegram WebApp not available');
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', function() {
        testWebAppConnection();
        
        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 16);
        document.querySelector('input[name="problem_date"]').value = localDateTime;
    });
</script>
</body>
</html>
